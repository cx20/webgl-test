<!DOCTYPE html>
<html>
<head>
  <title>[WIP] Testing Composite sample Using WebGL 1.0</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <script src="//code.jquery.com/jquery-3.4.0.js"></script>
  <script src="https://unpkg.com/gl-matrix@3.4.4/gl-matrix-min.js"></script>
</head>
<body>

<script id="vs" type="x-shader/x-vertex">
attribute vec3 aPosition;
attribute vec3 aNormal;
attribute vec2 aTexCoord;
attribute vec4 aJoints;
attribute vec4 aWeights;

uniform mat4 uModelMatrix;
uniform mat4 uViewMatrix;
uniform mat4 uProjectionMatrix;
uniform mat3 uNormalMatrix;
uniform mat4 uJointMatrices[180];
uniform bool uHasSkinning;

varying vec3 vNormal;
varying vec2 vTexCoord;
varying vec3 vPosition;

void main() {
    vec4 position = vec4(aPosition, 1.0);
    vec3 normal = aNormal;

    if (uHasSkinning) {
        mat4 skinMatrix =
            aWeights.x * uJointMatrices[int(aJoints.x + 0.5)] +
            aWeights.y * uJointMatrices[int(aJoints.y + 0.5)] +
            aWeights.z * uJointMatrices[int(aJoints.z + 0.5)] +
            aWeights.w * uJointMatrices[int(aJoints.w + 0.5)];
        position = skinMatrix * position;
        normal = mat3(skinMatrix) * normal;
    }

    vec4 worldPosition = uModelMatrix * position;
    vPosition = worldPosition.xyz;
    vNormal = uNormalMatrix * normal;
    vTexCoord = aTexCoord;
    gl_Position = uProjectionMatrix * uViewMatrix * worldPosition;
}
</script>

<script id="fs" type="x-shader/x-fragment">
precision highp float;

varying vec3 vNormal;
varying vec2 vTexCoord;
varying vec3 vPosition;

uniform sampler2D uTexture;
uniform bool uHasTexture;
uniform vec4 uBaseColor;
uniform vec3 uLightDir;

void main() {
    vec3 normal = normalize(vNormal);
    vec3 lightDir = normalize(uLightDir);
    
    float diff = max(dot(normal, lightDir), 0.0);
    float ambient = 0.3;
    float lighting = ambient + diff * 0.7;
    
    vec4 baseColor;
    if (uHasTexture) {
        baseColor = texture2D(uTexture, vTexCoord);
    } else {
        baseColor = uBaseColor;
    }
    
    vec3 finalColor = baseColor.rgb * lighting;
    finalColor = pow(finalColor, vec3(1.0 / 2.2));
    
    gl_FragColor = vec4(finalColor.rgb, baseColor.a);
}
</script>

<!-- Skybox Vertex Shader (WebGL 1.0) -->
<script id="vs-skybox" type="x-shader/x-vertex">
attribute vec3 aPosition;

uniform mat4 uProjectionMatrix;
uniform mat4 uViewMatrix;

varying vec3 vTexCoord;

void main() {
    vTexCoord = aPosition;
    
    vec4 pos = uProjectionMatrix * uViewMatrix * vec4(aPosition, 1.0);
    
    gl_Position = pos.xyww;
}
</script>

<!-- Skybox Fragment Shader (WebGL 1.0) -->
<script id="fs-skybox" type="x-shader/x-fragment">
precision highp float;

varying vec3 vTexCoord;

uniform samplerCube uSkybox;

void main() {
    gl_FragColor = textureCube(uSkybox, vTexCoord);
}
</script>

<!-- Tire Track Vertex Shader -->
<script id="vs-track" type="x-shader/x-vertex">
attribute vec3 aPosition;

uniform mat4 uModelMatrix;
uniform mat4 uViewMatrix;
uniform mat4 uProjectionMatrix;

void main() {
    gl_Position = uProjectionMatrix * uViewMatrix * uModelMatrix * vec4(aPosition, 1.0);
}
</script>

<!-- Tire Track Fragment Shader -->
<script id="fs-track" type="x-shader/x-fragment">
precision highp float;

uniform vec4 uColor;

void main() {
    gl_FragColor = uColor;
}
</script>

<canvas id="c" width="465" height="465"></canvas>
<script type="module" src="index.js"></script>
</body>
</html>
