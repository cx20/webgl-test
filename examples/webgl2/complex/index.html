<!DOCTYPE html>
<html>
<head>
  <title>[WIP] Testing Composite sample Using WebGL 2.0</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <script src="//code.jquery.com/jquery-3.4.0.js"></script>
  <script src="https://unpkg.com/gl-matrix@3.4.4/gl-matrix-min.js"></script>
</head>
<body>

<script id="vs" type="x-shader/x-vertex">#version 300 es
in vec3 aPosition;
in vec3 aNormal;
in vec2 aTexCoord;

uniform mat4 uModelMatrix;
uniform mat4 uViewMatrix;
uniform mat4 uProjectionMatrix;
uniform mat3 uNormalMatrix;

out vec3 vNormal;
out vec2 vTexCoord;
out vec3 vPosition;

void main() {
    vec4 worldPosition = uModelMatrix * vec4(aPosition, 1.0);
    vPosition = worldPosition.xyz;
    vNormal = uNormalMatrix * aNormal;
    vTexCoord = aTexCoord;
    gl_Position = uProjectionMatrix * uViewMatrix * worldPosition;
}
</script>

<script id="fs" type="x-shader/x-fragment">#version 300 es
precision highp float;

in vec3 vNormal;
in vec2 vTexCoord;
in vec3 vPosition;

uniform sampler2D uTexture;
uniform bool uHasTexture;
uniform vec4 uBaseColor;
uniform vec3 uLightDir;

out vec4 fragColor;

void main() {
    vec3 normal = normalize(vNormal);
    vec3 lightDir = normalize(uLightDir);
    
    float diff = max(dot(normal, lightDir), 0.0);
    float ambient = 0.3;
    float lighting = ambient + diff * 0.7;
    
    vec4 baseColor;
    if (uHasTexture) {
        baseColor = texture(uTexture, vTexCoord);
    } else {
        baseColor = uBaseColor;
    }

    vec3 finalColor = baseColor.rgb * lighting;
    finalColor = pow(finalColor, vec3(1.0 / 2.2));
    
    fragColor = vec4(finalColor, baseColor.a);
}
</script>

<!-- Skybox Vertex Shader -->
<script id="vs-skybox" type="x-shader/x-vertex">#version 300 es
layout(location = 0) in vec3 aPosition;

out vec3 vTexCoord;

uniform mat4 uProjectionMatrix;
uniform mat4 uViewMatrix;

void main() {
    vTexCoord = aPosition;
    
    vec4 pos = uProjectionMatrix * uViewMatrix * vec4(aPosition, 1.0);
    
    gl_Position = pos.xyww;
}
</script>

<!-- Skybox Fragment Shader -->
<script id="fs-skybox" type="x-shader/x-fragment">#version 300 es
precision highp float;

in vec3 vTexCoord;

uniform samplerCube uSkybox;

out vec4 fragColor;

void main() {
    fragColor = texture(uSkybox, vTexCoord);
}
</script>

<canvas id="c" width="465" height="465"></canvas>
<script type="module" src="index.js"></script>
</body>
</html>
